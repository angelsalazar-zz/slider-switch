<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="highlight-behavior.html">

<dom-module id="slider-switch">
   <template>
     <style>
         :host {
             display: block;
         }
         .switch{
             position: absolute;
             margin-left: -5px;
             height: 100%;
             width: 10px;
             stroke: #90CAF9;
             stroke-width: 2;
             fill: #90CAF9;
         }
         .switch:hover{
             stroke: #1565C0;
             fill: #1565C0;
         }
         .highlighted {
           stroke: #FF9800;
           fill: #FF9800;
         }
         .highlighted:hover {
           stroke: #B71C1C;
           fill: #B71C1C;
         }
         .value {
           position: absolute;
           background-color: #7CADAD;
           color: #EEEEEE;
           padding: 3px;
           width: auto;
           height: auto;
           margin-left: -12px;
           font: 11px arial, sans-serif;
           border: .5px solid;
           border-radius: 10px;
         }
    </style>
    <div class="value"
        style$="left:{{position}}px; display:{{visibility}}; top:{{topPos}}px">
        {{value}}</div>
    <svg class$="switch {{class}}"
        style$="left:{{position}}px">
        <polygon points$="{{points}}" />
    </svg>
  </template>
   <script>
       Polymer({
           is: 'slider-switch',
           behaviors: [HighlightBehavior],
           listeners: {
               down: '_handleDown'
           },
           properties:{
               position: {
                   type: Number,
                   value: 0,
                   reflectToAttribute: true,
                   notify: true
               },
               isDragging: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    observer: "_displayText"
                },
               isSelected: {
                   type: Boolean,
                   value: false,
                   reflectToAttribute: true
               },
               _startX:{
                   type: Number,
                   value: 0
               },
               index:{
                   type:Number,
                   reflectToAttribute: true
               },
               topPos:{
                 type: Number,
                 reflectToAttribute: true
               },
               isSelectable:{
                 type: Boolean,
                 value:false,
                 reflectToAttribute:true
               },
               value: {
                  type:Number,
                  notify:true,
                  reflectToAttribute:true
                },
           },
           attached:function(){
              var _zone = Polymer.dom(this).parentNode;
              this.position = Math.round((this.value*_zone.getBoundingClientRect().width)/(_zone.maxValue));
            },
            _updateValueAndPosition(newPosition){
              this.position = newPosition;
              var _zone = Polymer.dom(this).parentNode;
              this.value = Math.round((newPosition*(_zone.maxValue))/(_zone.getBoundingClientRect().width));
            },
           _handleDown: function(e){
               e.preventDefault();
               this._startX = e.detail.x;
               this.listen(this, 'track', '_handleMove');
               this.listen(this, 'up', '_handleUp');
               this.visibility = "block";
            },
           _handleMove: function(e){
               e.preventDefault();
               var deltaX = e.detail.x - this._startX;
               var _parent = Polymer.dom(this).parentNode;
               var _children = Polymer.dom(_parent).querySelectorAll("slider-switch");
               for(var i=0;i<_children.length;i++){
                   if(_children[i].isSelected){
                       if(!_children[i].isDragging){
                           _children[i].isDragging = true;
                        }
                        var newPosition = _children[i].position + deltaX;
                        if(newPosition >= 0 && newPosition <= _parent.getBoundingClientRect().width){
                            if(!_parent.hasReachedMaxLimit && !_parent.hasReachedMinLimit){
                                _children[i]._updateValueAndPosition(newPosition);
                                _parent.checkLimitReached(newPosition);
                            }
                            if(_parent.hasReachedMaxLimit && (deltaX < 0)){
                                _children[i]._updateValueAndPosition(newPosition);
                                _parent.checkLimitReached(newPosition);
                            }
                            if(_parent.hasReachedMinLimit && (deltaX > 0)){
                                _children[i]._updateValueAndPosition(newPosition);
                                _parent.checkLimitReached(newPosition);
                            }

                        }
                   }
               }
               this._startX = e.detail.x;
            },
           _handleUp: function(e){
               e.preventDefault();
               var _children = Polymer.dom(Polymer.dom(this).parentNode).querySelectorAll("slider-switch");
               for(var i=0;i<_children.length;i++){
                   if(_children[i].isDragging){
                       _children[i].isDragging = false;
                   }
               }
               this.visibility = "none";
               this.unlisten(this, 'track', '_handleMove');
               this.unlisten(this, 'up', '_handleUp');
            },
            _displayText:function(value){
              if(value){
                this.visibility = "block";
              } else {
                this.visibility = "none";

              }
            }
       });
  </script>
</dom-module>
